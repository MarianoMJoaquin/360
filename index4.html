<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visor 360° con Selector de Color</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  
  <div class="flex flex-col items-center space-y-4">
    <!-- Visor 360° -->
    <div class="w-[600px] h-[316px] overflow-hidden cursor-grab bg-cover bg-no-repeat bg-[url('corolla-red.png')] transition-transform ease-out duration-100 active:scale-105" id="viewer"></div>
    
    <!-- Selectores de Color -->
    <div class="flex space-x-4">
      <button class="w-10 h-10 rounded-full border-2 border-gray-300 bg-red-500 hover:scale-110 transition-transform duration-200 color-button" data-color="red"></button>
      <button class="w-10 h-10 rounded-full border-2 border-gray-300 bg-blue-500 hover:scale-110 transition-transform duration-200 color-button" data-color="blue"></button>
      <button class="w-10 h-10 rounded-full border-2 border-gray-300 bg-white hover:scale-110 transition-transform duration-200 color-button" data-color="white"></button>
    </div>
  </div>

  <script>
    const totalFrames = 30; // Número total de fotogramas
    let currentFrame = 0; // Fotograma actual
    let isDragging = false; // Indica si se está arrastrando el ratón o el dedo táctil para rotar el visor 360° 
    let startX = 0; // Posición inicial del arrastre en el eje X en píxeles 
    const frameWidthPercentage = 100 / totalFrames; // Ancho de cada fotograma en porcentaje 
    const viewer = document.getElementById('viewer'); // Elemento contenedor del visor 360° 

    // Función para cambiar el sprite según el color seleccionado
    function changeColor(color) {
      viewer.style.backgroundImage = `url('corolla-${color}.png')`;
      currentFrame = 0; // Reinicia al primer fotograma al cambiar de color
      viewer.style.backgroundPosition = `0 0`; // Asegura que comience desde el inicio
    }

    // Actualizar el fotograma mostrado en función del movimiento del arrastre
    function updateFrame(diffX) {
      if (diffX > 20) {
        currentFrame = (currentFrame + 1) % totalFrames;
        startX += 20;
      } else if (diffX < -20) {
        currentFrame = (currentFrame - 1 + totalFrames) % totalFrames;
        startX -= 20;
      }
      const offsetX = currentFrame * frameWidthPercentage;
      viewer.style.backgroundPosition = `${offsetX}% 0`;
    }

    function animate() {
      if (isDragging) {
        requestAnimationFrame(animate);
      }
    }

    viewer.addEventListener('mousedown', (event) => {
      isDragging = true;
      startX = event.pageX;
      viewer.classList.add("cursor-grabbing");
      requestAnimationFrame(animate);
    });

    viewer.addEventListener('mouseup', () => {
      isDragging = false;
      viewer.classList.remove("cursor-grabbing");
    });

    viewer.addEventListener('mouseleave', () => {
      isDragging = false;
      viewer.classList.remove("cursor-grabbing");
    });

    viewer.addEventListener('mousemove', (event) => {
      if (isDragging) {
        const diffX = event.pageX - startX;
        updateFrame(diffX);
      }
    });

    // --- Soporte para dispositivos táctiles ---
    viewer.addEventListener('touchstart', (event) => {
      isDragging = true;
      startX = event.touches[0].pageX;
      requestAnimationFrame(animate);
    });

    viewer.addEventListener('touchend', () => {
      isDragging = false;
    });

    viewer.addEventListener('touchmove', (event) => {
      if (isDragging) {
        const diffX = event.touches[0].pageX - startX;
        updateFrame(diffX);
      }
    });

    // Selector de color
    document.querySelectorAll('.color-button').forEach(button => {
      button.addEventListener('click', () => {
        const color = button.getAttribute('data-color');
        changeColor(color);
      });
    });

    // Carga diferida del sprite solo cuando esté visible
    const spriteObserver = new IntersectionObserver(entries => {
      if (entries[0].isIntersecting) {
        viewer.style.backgroundImage = "url('corolla-red.png')"; // Carga inicial
        spriteObserver.disconnect();
      }
    }, { threshold: 0.1 });
    spriteObserver.observe(viewer);
  </script>

</body>
</html>
